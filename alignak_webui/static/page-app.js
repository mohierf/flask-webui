(function(){var f=function(){};if(!window.console){window.console={log:f,info:f,warn:f,debug:f,error:f};}}());$(document).ready(function(){$('#modal').on('hidden.bs.modal',function(){$('.sidebar').show();$('.actionbar').show();$(this).removeData('bs.modal');});$('#modal').on('shown.bs.modal',function(){$('.sidebar').hide();$('.actionbar').hide();}); $('#sidebar-menu').metisMenu(); $('#actions-menu').metisMenu();});function playAlertSound(){var audio=document.getElementById('alert-sound');var canPlay=audio&&!!audio.canPlayType&&audio.canPlayType('audio/wav')!="";if(canPlay){audio.play();sessionStorage.setItem("sound_play","1");$('#sound_alerting i.fa-ban').addClass('hidden');}}
var refresh_logs=true;var search_filter=app_search_string;var refresh_timeout=app_refresh_period;var nb_refresh_retry=0;function do_refresh_header(){if($('#hosts-states-popover-content').length==0&&$('#services-states-popover-content').length==0){return false}
if(refresh_logs)console.debug("Refreshing page header");$.ajax({url:"/refresh_header",method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){if(!html['html_livesynthesis']){if(refresh_logs)console.error("Bad data received, expected : html['livesynthesis']");return}
var lv=html['html_livesynthesis'];if($('#hosts-states-popover-content').length>0&&lv['hosts_states_popover']&&$('#services-states-popover-content').length>0&&lv['services_states_popover']){ $('#hosts-states-popover-content').html(lv['hosts_states_popover']);$('#services-states-popover-content').html(lv['services_states_popover']); var nb_problems=0;$('#hosts-states-popover-content tr').each(function(){nb_problems+=parseInt($(this).data("problems"));});$('#services-states-popover-content tr').each(function(){nb_problems+=parseInt($(this).data("problems"));});if(refresh_logs)console.debug("Hosts/Services problems",nb_problems);var popoverTemplate=['<div class="popover img-popover">','<div class="arrow"></div>','<div class="popover-inner">','<h3 class="popover-title"></h3>','<div class="popover-content"></div>','</div>','</div>'].join(''); $('#overall-hosts-states').html(lv['hosts_state']);$('#overall-hosts-states a').popover({trigger:'focus hover',placement:'bottom',animation:true,html:true,template:popoverTemplate,container:'body',content:function(){return $('#hosts-states-popover-content').html();}}); $('#overall-services-states').html(lv['services_state']);$('#overall-services-states a').popover({trigger:'focus hover',placement:'bottom',animation:true,html:true,template:popoverTemplate,container:'body',content:function(){return $('#services-states-popover-content').html();}});var old_problems=Number(sessionStorage.getItem("how_many_problems_actually")); if(sessionStorage.getItem("sound_play")=='1'){if(!sessionStorage.getItem("how_many_problems_actually")){sessionStorage.setItem("how_many_problems_actually",nb_problems);}
if(refresh_logs)console.debug("Hosts/Services - stored problems number:",old_problems);if(old_problems<nb_problems){if(refresh_logs)console.debug("Dashboard - play sound!");playAlertSound();}}
sessionStorage.setItem("how_many_problems_actually",nb_problems);}});}
function do_refresh_livestate(search){if(!$('#livestate-list').length){return false}
if(refresh_logs)console.debug("Refreshing system live state, filter: ",search);$.ajax({url:"/livesynthesis",method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){if(refresh_logs)console.debug("Livesynthesis:",html);if(!html['livesynthesis']){if(refresh_logs)console.error("Bad data received, expected : html['livesynthesis']");return} 
if($("#chart-hosts").length!==0){synthesis=html['livesynthesis']['hosts_synthesis'];var data=[];$.each(pie_hosts_graph_states,function(index,value){ row=pie_hosts_graph_parameters[value];row['value']=synthesis['nb_'+value]
data.push(row)
if(states_queue["nb_"+value].length>hosts_states_queue_length){states_queue["nb_"+value].shift();}
states_queue["nb_"+value].push(synthesis['nb_'+value]);}); var ctx=$("#chart-hosts canvas").get(0).getContext("2d");var myPieChart=new Chart(ctx).Doughnut(data,pie_hosts_graph_options);$("#chart-hosts span.subtitle").html(synthesis['nb_elts']+" hosts");if(pie_hosts_graph_options){if($("#chart-hosts span.legend").length){if(!$("#pie_hosts_graph_options-legend").length){$("#chart-hosts span.legend").append(myPieChart.generateLegend());}}}} 
if($("#chart-hosts-serie").length!==0){synthesis=html['livesynthesis']['hosts_synthesis'];var data=[];data['labels']=line_hosts_graph_data['labels'];data['datasets']=[];$.each(line_hosts_graph_states,function(index,value){ row=line_hosts_graph_data['datasets'][value];row['data']=states_queue["nb_"+value];data['datasets'].push(row);}); var ctx=$("#chart-hosts-serie canvas").get(0).getContext("2d");var myLineChart=new Chart(ctx).Line(data,line_hosts_graph_options);$("#chart-hosts-serie span.subtitle").html(synthesis['nb_elts']+" hosts (progression)");if(line_hosts_graph_options){if($("#chart-hosts-serie span.legend").length){if(!$("#line_hosts_graph_options-legend").length){$("#chart-hosts-serie span.legend").append(myLineChart.generateLegend());}}}} 
if($("#chart-services").length!==0){synthesis=html['livesynthesis']['services_synthesis'];var data=[];$.each(pie_services_graph_states,function(index,value){ row=pie_services_graph_parameters[value];row['value']=synthesis['nb_'+value]
data.push(row)
if(states_queue["nb_"+value].length>services_states_queue_length){states_queue["nb_"+value].shift();}
states_queue["nb_"+value].push(synthesis['nb_'+value]);}); var ctx=$("#chart-services canvas").get(0).getContext("2d");var myPieChart=new Chart(ctx).Doughnut(data,pie_services_graph_options);$("#chart-services span.subtitle").html(synthesis['nb_elts']+" services");if(pie_services_graph_options){if($("#chart-services span.legend").length){if(!$("#pie_services_graph_options-legend").length){$("#chart-services span.legend").append(myPieChart.generateLegend());}}}} 
if($("#chart-services-serie").length!==0){synthesis=html['livesynthesis']['services_synthesis'];var data=[];data['labels']=line_services_graph_data['labels'];data['datasets']=[];$.each(line_services_graph_states,function(index,value){ row=line_services_graph_data['datasets'][value];row['data']=states_queue["nb_"+value];data['datasets'].push(row);}); var ctx=$("#chart-services-serie canvas").get(0).getContext("2d");var myLineChart=new Chart(ctx).Line(data,line_services_graph_options);$("#chart-services-serie span.subtitle").html(synthesis['nb_elts']+" services (progression)");if(line_services_graph_options){if($("#chart-services-serie span.legend").length){if(!$("#line_services_graph_options-legend").length){$("#chart-services-serie span.legend").append(myLineChart.generateLegend());}}}}});var bi;for(bi=5;bi>=0;--bi){$.ajax({url:"/refresh_livestate",data:{"bi":bi,"search":search_filter},method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){if(refresh_logs)console.debug("Livestate:",html);if(!html['livestate']){if(refresh_logs)console.error("Bad data received, expected : html['livestate']");return}
var bi=parseInt(html['livestate']['bi']);var rows=html['livestate']['rows'];if(!rows.length){if(refresh_logs)console.debug("No data for BI:",bi);return}
if(refresh_logs)console.debug("Received Livestate for BI:",bi);if(!$('#livestate-bi-'+bi).length){$('#livestate-list').append(html['livestate']['panel_bi']);$.each(html['livestate']['rows'],function(index,value){ $('#livestate-bi-'+bi+' table tbody').append(value);});}else{$('#livestate-bi-'+bi).hide(1000,function(){$('#livestate-bi-'+bi).replaceWith(html['livestate']['panel_bi']);$.each(html['livestate']['rows'],function(index,value){ $('#livestate-bi-'+bi+' table tbody').append(value);});$('#livestate-bi-'+bi).show(500);});}});}}
function do_refresh(){if(refresh_logs)console.debug("Refreshing page, timeout: ",refresh_timeout);
$.ajax({url:"/app_settings",method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){search_filter=html.search_string;if(refresh_logs)console.log("Search filter: ",search_filter);do_refresh_header();do_refresh_livestate();});}
function check_UI_backend(){reset_refresh();$.ajax({url:'/ping'}).done(function(data,textStatus,jqXHR){if(refresh_logs)console.log("ping",data);if(sessionStorage.getItem("refresh_active")=='1'){nb_refresh_retry=0; do_refresh();}}).fail(function(jqXHR,textStatus,errorThrown){if(refresh_logs)console.error('UI backend is not available, retrying later ...');postpone_refresh();});}
function check_refresh(){if(sessionStorage.getItem("refresh_active")=='1'){if(refresh_logs)console.debug("check_refresh: "+refresh_timeout+" seconds");if(refresh_timeout<0){check_UI_backend();}
refresh_timeout-=1;}else{nb_refresh_retry=0;refresh_timeout=app_refresh_period;}}
function postpone_refresh(){ if(nb_refresh_retry>0){alertify.log("The Web UI backend is not available","info",5000);}
nb_refresh_retry+=1;reset_refresh();}
function reset_refresh(){refresh_timeout=app_refresh_period;if(nb_refresh_retry>3){ refresh_timeout=1.3*app_refresh_period;}else if(nb_refresh_retry>6){ refresh_timeout=1.6*app_refresh_period;}else if(nb_refresh_retry>6){nb_refresh_retry=0;refresh_timeout=app_refresh_period;}
if(refresh_logs)console.debug("Refresh period restarted: "+nb_refresh_retry+" attempts, "+refresh_timeout+" seconds");}
$(document).ajaxStart(function(){if(sessionStorage.getItem("refresh_active")=='1'){$('#app_refreshing').addClass('fa-spin');}});$(document).ajaxStop(function(){if(sessionStorage.getItem("refresh_active")=='1'){ $('#app_refreshing').removeClass('fa-spin');}});$(document).ajaxError(function(event,jqxhr,settings,thrownError){console.error("Ajax error.",thrownError,settings.url);if(refresh_logs)console.error("Details:");if(refresh_logs)console.error(jqxhr);if(refresh_logs)console.error(settings);});$(document).ready(function(){setInterval("check_refresh();",1000);do_refresh();});