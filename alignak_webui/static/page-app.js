(function(){var f=function(){};if(!window.console){window.console={log:f,info:f,warn:f,debug:f,error:f};}}());$(document).ready(function(){$('#modal').on('hidden.bs.modal',function(){$('.sidebar').show();$('.actionbar').show();$(this).removeData('bs.modal');});$('#modal').on('shown.bs.modal',function(){$('.sidebar').hide();$('.actionbar').hide();}); $('#sidebar-menu').metisMenu(); $('#actions-menu').metisMenu();});function playAlertSound(){var audio=document.getElementById('alert-sound');var canPlay=audio&&!!audio.canPlayType&&audio.canPlayType('audio/wav')!="";if(canPlay){audio.play();sessionStorage.setItem("sound_play","1");$('#sound_alerting i.fa-ban').addClass('hidden');}}
var refresh_logs=true;var search_filter=app_refresh_period;var refresh_timeout=app_refresh_period;var nb_refresh_retry=0;if(!sessionStorage.getItem("refresh_active")){if(refresh_logs)console.debug("Refresh active storage does not exist");sessionStorage.setItem("refresh_active",refresh_timeout==0?'0':'1');}
if(refresh_logs)console.debug("Refresh active is ",sessionStorage.getItem("refresh_active"),", refresh rate is: ",app_refresh_period);if(sessionStorage.getItem("refresh_active")=='1'){$('#header_loading').removeClass('font-greyed');}else{$('#header_loading').addClass('font-greyed');}
function do_refresh_header(){if($('#hosts-states-popover-content').length==0&&$('#services-states-popover-content').length==0){return false}
if(refresh_logs)console.debug("Refreshing page header");$('#header_loading').addClass('fa-spin');$.ajax({url:"/refresh_header",method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){if(html['livesynthesis']){if($('#hosts-states-popover-content').length>0&&html['livesynthesis']['hosts_states_popover']&&$('#services-states-popover-content').length>0&&html['livesynthesis']['services_states_popover']){ $('#hosts-states-popover-content').html(html['livesynthesis']['hosts_states_popover']);$('#services-states-popover-content').html(html['livesynthesis']['services_states_popover']); var nb_problems=0;$('#hosts-states-popover-content tr').each(function(){nb_problems+=parseInt($(this).data("problems"));});$('#services-states-popover-content tr').each(function(){nb_problems+=parseInt($(this).data("problems"));});if(refresh_logs)console.debug("Hosts/Services problems",nb_problems);var popoverTemplate=['<div class="popover img-popover">','<div class="arrow"></div>','<div class="popover-inner">','<h3 class="popover-title"></h3>','<div class="popover-content"></div>','</div>','</div>'].join(''); $('#overall-hosts-states').html(html['livesynthesis']['hosts_state']);$('#overall-hosts-states a').popover({trigger:'focus hover',placement:'bottom',animation:true,html:true,template:popoverTemplate,content:function(){return $('#hosts-states-popover-content').html();}}); $('#overall-services-states').html(html['livesynthesis']['services_state']);$('#overall-services-states a').popover({trigger:'focus hover',placement:'bottom',animation:true,html:true,template:popoverTemplate,content:function(){return $('#services-states-popover-content').html();}});var old_problems=Number(sessionStorage.getItem("how_many_problems_actually")); if(sessionStorage.getItem("sound_play")=='1'){if(!sessionStorage.getItem("how_many_problems_actually")){sessionStorage.setItem("how_many_problems_actually",nb_problems);}
if(refresh_logs)console.debug("Hosts/Services - stored problems number:",old_problems);if(old_problems<nb_problems){if(refresh_logs)console.debug("Dashboard - play sound!");playAlertSound();}}
sessionStorage.setItem("how_many_problems_actually",nb_problems);}}}).fail(function(jqXHR,textStatus,errorThrown){if(refresh_logs)console.error(jqXHR,errorThrown);if(refresh_logs)console.error(jqXHR.responseText);}).always(function(){if(sessionStorage.getItem("refresh_active")=='1'){$('#header_loading').removeClass('font-greyed');}else{$('#header_loading').addClass('font-greyed');}
if(refresh_logs)console.debug("Refresh active is ",sessionStorage.getItem("refresh_active")); $('#header_loading').removeClass('fa-spin');});}
function do_refresh_livestate(){if($('#livestate').length==0){return false}
if(refresh_logs)console.debug("Refreshing system live state");$('#header_loading').addClass('fa-spin');$.ajax({url:"/refresh_livestate",method:"get",dataType:"json"}).done(function(html,textStatus,jqXHR){if(refresh_logs)console.debug("Livestate",html);if(html['livestate']){if($('#livestate').length>0&&html['livestate'].length>0){$.each(html['livestate'],function(index,value){ $('#livestate table tbody').append(value);});}}}).fail(function(jqXHR,textStatus,errorThrown){if(refresh_logs)console.error(jqXHR,errorThrown);if(refresh_logs)console.error(jqXHR.responseText);}).always(function(){ $('#header_loading').removeClass('fa-spin');});}
function do_refresh(){if(refresh_logs)console.debug("Refreshing: ",document.URL);$('#header_loading').addClass('fa-spin');$.ajax({url:document.URL,method:"get",dataType:"html"}).done(function(html,textStatus,jqXHR){var $response=$('<div />').html(html);$('#page-content').html($response.find('#page-content').html());if($('#overall-hosts-states').length>0){$('#overall-hosts-states').html($response.find('#overall-hosts-states').html());$('#hosts-states-popover-content').html($response.find('#hosts-states-popover-content').html());$('#overall-services-states').html($response.find('#overall-services-states').html());$('#services-states-popover-content').html($response.find('#services-states-popover-content').html());var nb_problems=0;nb_problems+=parseInt($('#overall-hosts-states a span').html());nb_problems+=parseInt($('#overall-services-states a span').html());if(refresh_logs)console.debug("Hosts/Services problems",nb_problems);var old_problems=Number(sessionStorage.getItem("how_many_problems_actually")); if(sessionStorage.getItem("sound_play")=='1'){if(!sessionStorage.getItem("how_many_problems_actually")){sessionStorage.setItem("how_many_problems_actually",nb_problems);}
if(refresh_logs)console.debug("Dashboard currently - stored problems number:",old_problems);if(old_problems<nb_problems){if(refresh_logs)console.debug("Dashboard - play sound!");playAlertSound();}}
sessionStorage.setItem("how_many_problems_actually",nb_problems);}
if($('#one-eye-overall').length>0){$('#one-eye-overall').html($response.find('#one-eye-overall').html());$('#one-eye-icons').html($response.find('#one-eye-icons').html());var nb_problems=0;nb_problems+=parseInt($('#one-eye-overall-hosts').data("hosts-problems"));nb_problems+=parseInt($('#one-eye-overall-services').data("services-problems"));if(refresh_logs)console.debug("Dashboard currently - Hosts/Services problems",nb_problems);var old_problems=Number(sessionStorage.getItem("how_many_problems_actually")); if(sessionStorage.getItem("sound_play")=='1'){if(!sessionStorage.getItem("how_many_problems_actually")){sessionStorage.setItem("how_many_problems_actually",nb_problems);}
if(refresh_logs)console.debug("Dashboard currently - stored problems number:",old_problems);if(old_problems<nb_problems){if(refresh_logs)console.debug("Dashboard currently - play sound!");playAlertSound();}}
if(old_problems<nb_problems){var message=(nb_problems-old_problems)+" new "+((nb_problems-old_problems)==1?"problem":"problems")+" since last "+refresh_timeout+" seconds."
alertify.log((nb_problems-old_problems)+" new problems since last "+refresh_timeout+" seconds.","warning",5000);}
sessionStorage.setItem("how_many_problems_actually",nb_problems);if(refresh_logs)console.debug("Dashboard currently - updated stored problems number:",Number(sessionStorage.getItem("how_many_problems_actually")));}
$response.remove();if(typeof on_page_refresh!=='undefined'&&$.isFunction(on_page_refresh)){if(refresh_logs)console.debug('Calling page refresh function ...');on_page_refresh();} 
if(location.hash.length>0){if(refresh_logs)console.debug('Displaying tab: ',location.hash)
$('.nav-tabs li a[href="'+location.hash+'"]').trigger('click');}else{if(refresh_logs)console.debug('Displaying first tab')
$('.nav-tabs li a:first').trigger('click');}}).fail(function(jqXHR,textStatus,errorThrown){if(refresh_logs)console.error('Done: ',jqXHR,textStatus,errorThrown);}).always(function(){if(sessionStorage.getItem("refresh_active")=='1'){$('#header_loading').removeClass('font-greyed');}else{$('#header_loading').addClass('font-greyed');}
if(refresh_logs)console.debug("Refresh active is ",sessionStorage.getItem("refresh_active")); $('#header_loading').removeClass('fa-spin');});}
function check_UI_backend(){$.ajax({url:'/ping'}).done(function(){if(sessionStorage.getItem("refresh_active")=='1'){do_refresh_header();do_refresh_livestate();}
reinit_refresh();}).fail(function(jqXHR,textStatus,errorThrown){if(refresh_logs)console.error('UI backend is not available, retrying later ...');postpone_refresh();});}
function check_refresh(){if(refresh_timeout<0){

check_UI_backend();}
refresh_timeout=refresh_timeout-1;}
function postpone_refresh(){ if(nb_refresh_retry>0){alertify.log("The Web UI backend is not available","info",5000);}
nb_refresh_retry+=1;reinit_refresh();}
function reinit_refresh(){if(refresh_logs)console.debug("Refresh period restarted: "+app_refresh_period+" seconds"); refresh_timeout=app_refresh_period;nb_refresh_retry=0;}
function stop_refresh(){$('#header_loading').addClass('font-greyed');sessionStorage.setItem("refresh_active",'0');}
function start_refresh(){$('#header_loading').removeClass('font-greyed');sessionStorage.setItem("refresh_active",'1');}
$(document).ready(function(){setInterval("check_refresh();",1000);if(sessionStorage.getItem("refresh_active")=='1'){$('#header_loading').removeClass('font-greyed');}else{$('#header_loading').addClass('font-greyed');}
do_refresh_header();do_refresh_livestate();$('body').on("click",'[action="toggle-page-refresh"]',function(e,data){if(sessionStorage.getItem("refresh_active")=='1'){stop_refresh();}else{start_refresh();}
if(refresh_logs)console.debug("Refresh active is ",sessionStorage.getItem("refresh_active"));});});